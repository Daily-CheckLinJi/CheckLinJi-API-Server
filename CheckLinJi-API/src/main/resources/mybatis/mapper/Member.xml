<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.upside.api.mapper.MemberMapper">
	
	<!-- 내 미션 달성 횟수 , 참가자 평균 -->
	<select id="missionCompletedCnt" parameterType="MemberDto" resultType="java.util.Map" >
		SELECT count(*) as own , 
		 (SELECT ROUND(AVG(COUNT)) FROM (
		   SELECT COUNT(*) as count
		 	 FROM CHALLENGE_SUBMISSION CS 
			  JOIN USER_CHALLENGE UC 
			   ON CS.USER_CHALLENGE_ID = UC.USER_CHALLENGE_ID
			  WHERE year(CS.submission_time) = #{year} AND MONTH(CS.submission_time) = #{month} 
			  GROUP BY UC.EMAIL ) AS counts) as userAvg
		 FROM CHALLENGE_SUBMISSION CS 
		  JOIN USER_CHALLENGE UC 
		   ON CS.USER_CHALLENGE_ID = UC.USER_CHALLENGE_ID
		 WHERE year(CS.submission_time) = #{year} AND MONTH(CS.submission_time) = #{month} 
		   AND UC.EMAIL = #{email}					 
	</select>

	<!-- 실시간 랭킹 TOP 3 -->
	<select id="missionRankingTop" parameterType="MemberDto" resultType="java.util.Map" >
		SELECT @rank := @rank + 1 AS ranking, t.NICK_NAME, t.count 
			FROM (
			    SELECT MI.NICK_NAME, COUNT(*) AS count 
			    FROM CHALLENGE_SUBMISSION CS 
			    JOIN USER_CHALLENGE UC ON CS.USER_CHALLENGE_ID = UC.USER_CHALLENGE_ID
			    JOIN MEMBER_INFO MI ON UC.EMAIL = MI.EMAIL 			    
			    GROUP BY UC.EMAIL 
			    ORDER BY COUNT(*) DESC 
			) t, (SELECT @rank := 0) r 
			ORDER BY ranking ASC 
			LIMIT 3;			 
	</select>
	
	<!-- 실시간 본인 랭킹 -->
	<select id="missionRankingOwn" parameterType="MemberDto" resultType="java.util.Map" >
		SELECT val.rank, val.NICK_NAME, val.count
			FROM (
			  SELECT @rank := @rank + 1 AS rank, t.email, t.NICK_NAME, t.count 
			  FROM (
			    SELECT UC.EMAIL, MI.NICK_NAME, COUNT(*) AS count 
			    FROM CHALLENGE_SUBMISSION CS 
			    JOIN USER_CHALLENGE UC 
			    ON CS.USER_CHALLENGE_ID = UC.USER_CHALLENGE_ID
			    JOIN MEMBER_INFO MI 
			    ON UC.EMAIL = MI.EMAIL 			    
			    GROUP BY UC.EMAIL 
			    ORDER BY COUNT(*) DESC
			  ) t, (SELECT @rank := 0) r 
			) val 
			WHERE val.email = #{email} ; 		 
	</select>
</mapper>